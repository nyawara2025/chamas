import React, { useState, useEffect, createContext, useContext } from 'react';
import { BrowserRouter, Routes, Route, Navigate, useNavigate, useLocation } from 'react-router-dom';
import { getStoredUser, clearAuthData, setConfig } from './utils/apiClient';

// Page Imports
import Home from './pages/Home';
import Finance from './pages/Finance';
import MeetingNotes from './pages/MeetingNotes';
import MeetingAdmin from './pages/MeetingAdmin'; // Imported MeetingAdmin
import Broadcasts from './pages/Broadcasts';
import BroadcastDetail from './pages/BroadcastDetail';
import BroadcastAdmin from './pages/BroadcastAdmin';
import Opinions from './pages/Opinions';
import TableBanking from './pages/TableBanking';
import Chat from './pages/Chat';
import ChatAdmin from './pages/ChatAdmin';
import Login from './pages/Login';
import Profile from './pages/Profile';

// Context for configuration
export const ConfigContext = createContext(null);

// Bottom Navigation Component
const BottomNav = () => {
  const config = useContext(ConfigContext);
  const navigate = useNavigate();
  const location = useLocation();

  if (!config?.navigation?.showBottomNav) return null;

  const navItems = config.navigation?.menuOrder || [];

  const getIcon = (item) => {
    const icons = {
      home: 'ğŸ ',
      finance: 'ğŸ’°',
      meetingNotes: 'ğŸ“‹',
      broadcasts: 'ğŸ“¢',
      marketplace: 'ğŸ›’',
      events: 'ğŸ“…',
      profile: 'ğŸ‘¤',
      opinions: 'ğŸ—£ï¸'
    };
    return icons[item] || 'â€¢';
  };

  return (
    <nav style={{
      position: 'fixed',
      bottom: 0,
      left: 0,
      right: 0,
      background: 'white',
      borderTop: '1px solid #e5e7eb',
      padding: '8px 0',
      display: 'flex',
      justifyContent: 'space-around',
      zIndex: 1000,
      paddingBottom: 'calc(8px + env(safe-area-inset-bottom, 0px))'
    }}>
      {navItems.map((item) => {
        const isActive = location.pathname === `/${item}` || 
                        (item === 'home' && location.pathname === '/');
        const isEnabled = config.features?.[item] !== false;

        if (!isEnabled) return null;

        return (
          <button
            key={item}
            onClick={() => navigate(`/${item === 'home' ? '' : item}`)}
            style={{
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'center',
              gap: '4px',
              background: 'none',
              border: 'none',
              cursor: 'pointer',
              padding: '8px 12px',
              color: isActive ? config.theme?.colors?.primary : '#64748b',
              transition: 'all 0.2s ease'
            }}
          >
            <span style={{ fontSize: '1.25rem' }}>{getIcon(item)}</span>
            <span style={{ 
              fontSize: '0.625rem', 
              fontWeight: 500,
              textTransform: 'capitalize'
            }}>
              {item.replace(/([A-Z])/g, ' $1').trim()}
            </span>
          </button>
        );
      })}
    </nav>
  );
};

// Header Component
const Header = () => {
  const config = useContext(ConfigContext);
  const navigate = useNavigate();
  const location = useLocation();
  const user = getStoredUser();

  const getTitle = () => {
    const path = location.pathname;
    if (path === '/') return config?.identity?.name || 'Home';
    if (path.includes('finance')) return config?.modules?.payments?.name || 'Contributions';
    if (path.includes('meeting-notes')) return config?.modules?.meetingNotes?.name || 'Meeting Notes';
    if (path.includes('broadcasts')) return config?.labels?.broadcastsLabel || 'Updates';
    if (path.includes('sokoni')) return config?.labels?.marketplaceLabel || 'Sokoni';
    if (path.includes('opinions')) return 'Opinions';
    if (path.includes('table-banking')) return config?.labels?.tableBankingLabel || 'Table Banking';
    if (path.includes('profile')) return config?.labels?.profileLabel || 'Profile';
    if (path.includes('broadcast-admin')) return 'Create Update';
    return 'Care Kenya';
  };

  return (
    <header style={{
      position: 'sticky',
      top: 0,
      zIndex: 100,
      background: 'white',
      borderBottom: '1px solid #e5e7eb',
      padding: '12px 16px',
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center'
    }}>
      <h1 style={{
        margin: 0,
        fontSize: '1rem',
        fontWeight: 600,
        color: config?.theme?.colors?.primary || '#E31C23',
        flex: 1
      }}>
        {getTitle()}
      </h1>
      
      {user && (
        <button
          onClick={() => navigate('/profile')}
          style={{
            background: 'none',
            border: 'none',
            cursor: 'pointer',
            padding: '4px 8px',
            fontSize: '0.875rem',
            color: '#64748b'
          }}
        >
          {user.first_name || user.full_name || 'Profile'} ğŸ‘¤
        </button>
      )}
    </header>
  );
};

// Loading Component
const Loading = () => (
  <div style={{
    display: 'flex',
    flexDirection: 'column',
    alignItems: 'center',
    justifyContent: 'center',
    minHeight: '100vh',
    background: '#F3F4F6'
  }}>
    <div style={{
      width: '40px',
      height: '40px',
      border: '3px solid #e5e7eb',
      borderTopColor: '#E31C23',
      borderRadius: '50%',
      animation: 'spin 1s linear infinite'
    }} />
    <p style={{ marginTop: '16px', color: '#64748b' }}>Loading...</p>
    <style>{`
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    `}</style>
  </div>
);

// Main Layout
const Layout = ({ children }) => {
  const config = useContext(ConfigContext);
  
  return (
    <div style={{
      minHeight: '100vh',
      background: config?.theme?.colors?.background || '#F3F4F6',
      paddingBottom: config?.navigation?.showBottomNav ? '80px' : '0'
    }}>
      <Header />
      <main>{children}</main>
      <BottomNav />
    </div>
  );
};

// Protected Route Wrapper
const ProtectedRoute = ({ children }) => {
  const user = getStoredUser();
  
  if (!user) {
    return <Navigate to="/login" replace />;
  }
  
  return <Layout>{children}</Layout>;
};

// Logout Handler
const Logout = () => {
  clearAuthData();
  return <Navigate to="/login" replace />;
};

function App() {
  const [config, setConfigState] = useState(null); 
  const [loading, setLoading] = useState(true);
  
  // Define user at the top level of the function
  const user = getStoredUser();

  useEffect(() => {
    fetch('/config.json')
      .then((res) => {
        if (!res.ok) throw new Error('Failed to load config');
        return res.json();
      })
      .then((data) => {
        setConfig(data); 
        setConfigState(data);
        setLoading(false);
      })
      .catch((err) => {
        console.error('Error loading config:', err);
        setLoading(false);
      });
  }, []);

  if (loading) return <Loading />;

  return (
    <ConfigContext.Provider value={config}>
        <Routes>
          {/* Public Routes */}
          <Route path="/login" element={<Login />} />
          <Route path="/logout" element={<Logout />} />

          {/* Protected Routes */}
          <Route path="/" element={<ProtectedRoute><Home /></ProtectedRoute>} />
          <Route path="/home" element={<ProtectedRoute><Home /></ProtectedRoute>} />
          
          {/* Finance/Contributions */}
          {config?.features?.finance && (
            <Route path="/finance" element={<ProtectedRoute><Finance /></ProtectedRoute>} />
          )}
          
          {/* Meeting Notes */}
          {config?.features?.meetingNotes && (
            <>
              <Route path="/meeting-notes" element={<ProtectedRoute><MeetingNotes /></ProtectedRoute>} />
              <Route path="/meetingNotes" element={<ProtectedRoute><MeetingNotes /></ProtectedRoute>} />
            </>
          )}

          {/* Meeting Admin - Only for Admins */}
          {config?.features?.meetingNotes && user?.role === 'admin' && (
            <Route path="/meeting-admin" element={<ProtectedRoute><MeetingAdmin /></ProtectedRoute>} />
          )}
          
          {/* Table Banking */}
          {config?.features?.tablebanking && (
             <Route path="/table-banking" element={<ProtectedRoute><TableBanking /></ProtectedRoute>} />
          )}

          {/* Broadcasts */}
          {config?.features?.broadcasts && (
            <>
              <Route path="/broadcasts" element={<ProtectedRoute><Broadcasts /></ProtectedRoute>} />
              <Route path="/broadcast/:id" element={<ProtectedRoute><BroadcastDetail /></ProtectedRoute>} />
              {user?.role === 'admin' && (
                <Route path="/broadcast-admin" element={<ProtectedRoute><BroadcastAdmin /></ProtectedRoute>} />
              )}
            </>
          )}

          {/* Profile */}
          <Route path="/profile" element={<ProtectedRoute><Profile /></ProtectedRoute>} />

          {/* Fallback */}
          <Route path="*" element={<Navigate to="/" replace />} />
        </Routes>
    </ConfigContext.Provider>
  );
}

export default App;
